<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MOVIE NIGHT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #141414;
      color: #fff;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
      padding: 20px 40px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    h1 {
      font-family: 'Bebas Neue', 'Arial Black', sans-serif;
      font-size: 3.2em;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #E50914;
      text-transform: uppercase;
      position: relative;
      display: inline-block;
      margin: 0;
      text-shadow: 
        2px 2px 0px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(229, 9, 20, 0.4);
    }

    .user-select {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-icon {
      font-size: 1.5em;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .user-icon:hover {
      transform: scale(1.2);
    }

    .icon-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .icon-option {
      font-size: 2em;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .icon-option:hover {
      background: rgba(255,255,255,0.2);
      border-color: #e50914;
      transform: scale(1.1);
    }

    .proposer-icon {
      font-size: 1.2em;
      margin-right: 5px;
    }

    /* PIN Login */
    .pin-container {
      text-align: center;
    }

    .pin-display {
      font-size: 3em;
      letter-spacing: 20px;
      margin: 20px 0;
      font-family: monospace;
      min-height: 60px;
    }

    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 300px;
      margin: 0 auto;
    }

    .pin-btn {
      padding: 20px;
      font-size: 2em;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pin-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: #e50914;
    }

    .pin-btn:active {
      transform: scale(0.95);
    }

    .pin-btn.wide {
      grid-column: span 3;
    }

    .setup-link {
      margin-top: 30px;
      color: #e50914;
      cursor: pointer;
      text-decoration: underline;
      font-size: 1.1em;
      padding: 15px;
      display: inline-block;
    }

    .setup-link:hover {
      color: #f40612;
    }

    .setup-link:active {
      transform: scale(0.98);
    }

    .user-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .user-card {
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .user-card:hover {
      background: rgba(255,255,255,0.2);
      border-color: #e50914;
      transform: scale(1.05);
    }

    .user-card-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .user-card-name {
      font-size: 1.3em;
      font-weight: 600;
    }

    .error-message {
      color: #ff4444;
      margin-top: 15px;
      font-weight: 600;
    }

    select, button {
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    select {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button {
      background: #e50914;
      color: white;
      font-weight: 600;
    }

    button:hover:not(:disabled) {
      background: #f40612;
      transform: scale(1.05);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Phase Indicator */
    .phase-banner {
      padding: 20px 40px;
      text-align: center;
      font-size: 1.1em;
      font-weight: 600;
    }

    .phase-banner.nomination {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .phase-banner.voting {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .phase-banner.results {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    }

    .countdown {
      margin-top: 10px;
      font-size: 1.5em;
      font-weight: 700;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px;
    }

    /* Nominations Section */
    .nominations-section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 1.8em;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .nominations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .nomination-card {
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s;
      cursor: pointer;
      position: relative;
    }

    .nomination-card:hover {
      transform: scale(1.05);
    }

    .nomination-card.first-place {
      border: 3px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .nomination-card.second-place {
      border: 3px solid silver;
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.5);
    }

    .nomination-backdrop {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .nomination-info {
      padding: 15px;
    }

    .nomination-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .nomination-meta {
      display: flex;
      gap: 15px;
      color: #999;
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .rating {
      color: #ffd700;
    }

    .proposer {
      color: #e50914;
      font-weight: 600;
    }

    .vote-section {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .vote-btn {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
    }

    .vote-btn.voted {
      background: #e50914;
      border-color: #e50914;
    }

    .vote-count {
      font-weight: 700;
      font-size: 1.2em;
    }

    .place-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9em;
    }

    .place-badge.first {
      background: gold;
      color: #000;
    }

    .place-badge.second {
      background: silver;
      color: #000;
    }

    /* Browse Section */
    .browse-section {
      margin-bottom: 40px;
    }

    .search-container {
      margin-bottom: 30px;
      max-width: 100%;
      position: relative;
    }

    .search-input-wrapper {
      display: flex;
      gap: 10px;
      max-width: 600px;
    }

    .search-input {
      flex: 1;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: white;
      font-size: 16px;
    }

    .search-input:focus {
      outline: none;
      border-color: #e50914;
      background: rgba(255,255,255,0.15);
    }

    .search-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .search-btn {
      padding: 12px 30px;
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 500px;
      overflow-y: auto;
      background: #1c1c1c;
      border-radius: 8px;
      margin-top: 10px;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      display: none;
    }

    .search-suggestions.active {
      display: block;
    }

    .suggestion-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      transition: background 0.3s;
    }

    .suggestion-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-backdrop {
      width: 120px;
      height: 70px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .suggestion-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .suggestion-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .suggestion-meta {
      display: flex;
      gap: 15px;
      color: #999;
      font-size: 0.9em;
    }

    .suggestion-loading {
      padding: 20px;
      text-align: center;
      color: #999;
    }

    .browse-row {
      margin-bottom: 30px;
    }

    .row-title {
      font-size: 1.4em;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .movies-scroll {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
      scrollbar-width: thin;
      scrollbar-color: #e50914 #1c1c1c;
    }

    .movies-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .movies-scroll::-webkit-scrollbar-track {
      background: #1c1c1c;
    }

    .movies-scroll::-webkit-scrollbar-thumb {
      background: #e50914;
      border-radius: 4px;
    }

    .movie-card {
      min-width: 300px;
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .movie-card:hover {
      transform: scale(1.05);
    }

    .movie-backdrop {
      width: 100%;
      height: 170px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .movie-info {
      padding: 12px;
    }

    .movie-title {
      font-size: 1em;
      font-weight: 700;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-meta {
      display: flex;
      gap: 10px;
      color: #999;
      font-size: 0.85em;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
    }

    .tab {
      padding: 15px 30px;
      background: none;
      border: none;
      color: #999;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: white;
      border-bottom-color: #e50914;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* History */
    .history-item {
      background: #1c1c1c;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .history-week {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 15px;
      color: #e50914;
    }

    .history-winners {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1c1c1c;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 2em;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
    }

    .movie-detail {
      margin-bottom: 20px;
    }

    .detail-backdrop {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .detail-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .detail-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      color: #999;
    }

    .detail-overview {
      line-height: 1.6;
      color: #ccc;
    }

    .nominate-btn {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      font-size: 1.1em;
    }

    .waiting-message {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: #999;
    }

    @media (max-width: 768px) {
      .header {
        padding: 15px 20px;
      }

      .container {
        padding: 15px 20px;
      }

      h1 {
        font-size: 2.2em;
        letter-spacing: 0.03em;
      }

      .nominations-grid {
        grid-template-columns: 1fr;
      }

      .movie-card {
        min-width: 280px;
      }

      .nomination-card {
        font-size: 1.1em;
      }

      .nomination-title {
        font-size: 1.3em;
      }

      .vote-btn, .watched-btn {
        padding: 12px;
        font-size: 1.1em;
      }

      .section-title {
        font-size: 1.6em;
      }

      .row-title {
        font-size: 1.3em;
      }

      .search-input {
        font-size: 18px;
        padding: 14px 18px;
      }

      .search-btn {
        font-size: 16px;
        padding: 14px 24px;
      }

      /* Modal adjustments for mobile */
      .modal-content {
        width: 95%;
        max-width: 500px;
        padding: 25px;
      }

      .modal-header h2 {
        font-size: 1.5em;
      }

      .close-btn {
        font-size: 2.5em;
      }

      /* PIN pad mobile optimization */
      .pin-display {
        font-size: 2.5em;
        margin: 15px 0;
      }

      .pin-pad {
        max-width: 100%;
        gap: 12px;
      }

      .pin-btn {
        padding: 25px;
        font-size: 2em;
        min-height: 70px;
      }

      /* User cards mobile */
      .user-list {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .user-card {
        padding: 25px;
      }

      .user-card-icon {
        font-size: 4em;
      }

      .user-card-name {
        font-size: 1.5em;
      }

      /* Search suggestions mobile */
      .suggestion-item {
        padding: 12px;
      }

      .suggestion-backdrop {
        width: 100px;
        height: 60px;
      }

      .suggestion-title {
        font-size: 1em;
      }

      .suggestion-meta {
        font-size: 0.85em;
      }

      /* Movie detail modal */
      .detail-title {
        font-size: 1.6em;
      }

      .detail-meta {
        font-size: 1em;
      }

      .detail-overview {
        font-size: 1.05em;
        line-height: 1.6;
      }

      .nominate-btn {
        font-size: 1.2em;
        padding: 16px;
      }

      /* Icon picker */
      .icon-picker {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      .icon-option {
        font-size: 2.5em;
        padding: 18px;
      }

      /* Phase banner */
      .phase-banner {
        font-size: 1em;
        padding: 15px 20px;
      }

      .countdown {
        font-size: 1.3em;
      }

      /* Tabs */
      .tabs {
        gap: 10px;
      }

      .tab {
        padding: 12px 20px;
        font-size: 1em;
      }

      /* History */
      .history-week {
        font-size: 1.2em;
      }

      .history-winners {
        grid-template-columns: 1fr;
      }

      /* User info header */
      .user-select {
        gap: 10px;
      }

      .user-icon {
        font-size: 2em;
      }

      #userName {
        font-size: 1.3em !important;
      }

      select, button {
        font-size: 16px;
        padding: 12px 18px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>MOVIE NIGHT</h1>
      <div class="user-select" id="userInfo" style="display:none;">
        <span id="userIcon" class="user-icon" onclick="openIconPicker()" title="Click to change icon"></span>
        <span id="userName" style="font-size:1.2em; font-weight:600;"></span>
        <button onclick="logout()" style="margin-left:15px;">Logout</button>
      </div>
    </div>
  </div>

  <div id="phaseBanner" class="phase-banner"></div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('current')">This Week</button>
      <button class="tab" onclick="switchTab('history')">Previous Weeks</button>
    </div>

    <div id="currentTab" class="tab-content active">
      <div id="nominationsSection" class="nominations-section"></div>
      <div id="browseSection" class="browse-section"></div>
    </div>

    <div id="historyTab" class="tab-content">
      <div id="historyContent"></div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Movie Details</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    let currentUser = '';
    let state = null;
    let history = [];
    let countdown = null;
    let userIcons = {};
    let pinEntry = '';
    let setupMode = false;
    let setupUser = '';
    let searchTimeout = null;

    const availableIcons = [
      'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüî¨', 'üë©‚Äçüî¨', 'üë®‚Äçüé®', 'üë©‚Äçüé®',
      'üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è',
      'üßî', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'üëß', 'üßí',
      'üòé', 'ü§ì', 'ü•∏', 'ü§†', 'ü•≥', 'ü§©',
      'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è',
      'üßö‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'üßõ‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è',
      'üé≠', 'üé™', 'üé®', 'üé¨', 'üéÆ', 'üéØ',
      '‚ö°', 'üî•', '‚≠ê', '‚ú®', 'üí´', 'üåü',
      'ü¶ä', 'ü¶Å', 'üêØ', 'üêª', 'üêº', 'üê®',
      'ü¶Ñ', 'üêâ', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë'
    ];

    // Check for existing session
    async function checkSession() {
      const savedUser = localStorage.getItem('movieNightUser');
      if (savedUser) {
        currentUser = savedUser;
        await loadState();
        updateUserInfo();
      } else {
        // Load state first to get user icons for PIN setup screen
        const response = await fetch('/api/state');
        state = await response.json();
        userIcons = state.users || {};
        showPinLogin();
      }
    }

    function updateUserInfo() {
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userName').textContent = currentUser;
      const icon = userIcons[currentUser]?.icon || userIcons[currentUser] || 'üë§';
      document.getElementById('userIcon').textContent = icon;
    }

    function logout() {
      localStorage.removeItem('movieNightUser');
      currentUser = '';
      document.getElementById('userInfo').style.display = 'none';
      showPinLogin();
    }

    // PIN pad functions
    function showPinLogin() {
      document.getElementById('modalTitle').textContent = 'Enter Your PIN';
      pinEntry = '';
      setupMode = false;
      document.getElementById('modalBody').innerHTML = `
        <div class="pin-container">
          <div class="pin-display" id="pinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <div class="pin-pad">
            ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="pin-btn" onclick="addPin('${n}')">${n}</button>`).join('')}
            <button class="pin-btn" onclick="clearPin()">Clear</button>
            <button class="pin-btn" onclick="addPin('0')">0</button>
            <button class="pin-btn" onclick="submitPin()">‚úì</button>
          </div>
          <div id="pinError" class="error-message"></div>
          <div class="setup-link" onclick="showSetupChoice()">First time? Set up your PIN</div>
        </div>
      `;
      document.querySelector('.close-btn').style.display = 'none';
      document.getElementById('modal').classList.add('active');
    }

    async function showSetupChoice() {
      // Make sure we have state loaded
      if (!state || !state.users) {
        const response = await fetch('/api/state');
        state = await response.json();
        userIcons = state.users || {};
      }

      document.getElementById('modalTitle').textContent = 'Choose Your Name';
      document.querySelector('.close-btn').style.display = 'none';
      document.getElementById('modalBody').innerHTML = `
        <div class="pin-container">
          <p style="margin-bottom:20px; font-size:1.1em;">Select your name to set up your PIN:</p>
          <div class="user-list">
            ${Object.keys(state.users || {}).map(user => `
              <div class="user-card" onclick="startPinSetup('${user}')">
                <div class="user-card-icon">${state.users[user].icon}</div>
                <div class="user-card-name">${user}</div>
                ${state.users[user].pin ? '<div style="color:#4ade80;">‚úì PIN set</div>' : '<div style="color:#fbbf24;">No PIN yet</div>'}
              </div>
            `).join('')}
          </div>
          <div style="margin-top:20px;">
            <button onclick="showPinLogin()">Back to Login</button>
          </div>
        </div>
      `;
    }

    function startPinSetup(user) {
      setupUser = user;
      setupMode = true;
      pinEntry = '';
      document.getElementById('modalTitle').textContent = `Set PIN for ${user}`;
      document.getElementById('modalBody').innerHTML = `
        <div class="pin-container">
          <p style="margin-bottom:10px;">Enter a 4-digit PIN:</p>
          <div class="pin-display" id="pinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <div class="pin-pad">
            ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="pin-btn" onclick="addPin('${n}')">${n}</button>`).join('')}
            <button class="pin-btn" onclick="clearPin()">Clear</button>
            <button class="pin-btn" onclick="addPin('0')">0</button>
            <button class="pin-btn" onclick="submitPin()">Set PIN</button>
          </div>
          <div id="pinError" class="error-message"></div>
          <div style="margin-top:20px;">
            <button onclick="showSetupChoice()">Back</button>
          </div>
        </div>
      `;
    }

    function addPin(digit) {
      if (pinEntry.length < 4) {
        pinEntry += digit;
        updatePinDisplay();
      }
    }

    function clearPin() {
      pinEntry = '';
      updatePinDisplay();
      document.getElementById('pinError').textContent = '';
    }

    function updatePinDisplay() {
      const display = document.getElementById('pinDisplay');
      if (display) {
        display.textContent = '‚Ä¢'.repeat(pinEntry.length) + '¬∑'.repeat(4 - pinEntry.length);
      }
    }

    async function submitPin() {
      if (pinEntry.length !== 4) {
        document.getElementById('pinError').textContent = 'PIN must be 4 digits';
        return;
      }

      if (setupMode) {
        // Set PIN for user
        const response = await fetch('/api/user/pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: setupUser, pin: pinEntry })
        });

        const result = await response.json();

        if (result.error) {
          document.getElementById('pinError').textContent = result.error;
          return;
        }

        // Auto-login after setup
        currentUser = setupUser;
        localStorage.setItem('movieNightUser', currentUser);
        closeModal();
        await loadState();
        updateUserInfo();
      } else {
        // Login with PIN
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pin: pinEntry })
        });

        const result = await response.json();

        if (result.error) {
          document.getElementById('pinError').textContent = result.error;
          pinEntry = '';
          updatePinDisplay();
          return;
        }

        currentUser = result.user;
        localStorage.setItem('movieNightUser', currentUser);
        closeModal();
        await loadState();
        updateUserInfo();
      }
    }

    // Load current state
    async function loadState() {
      const response = await fetch('/api/state');
      state = await response.json();
      userIcons = state.users || {};
      updateUserInfo();
      renderPhase();
      renderNominations();
      if (currentUser) {
        await loadBrowse();
      }
    }

    // Open icon picker
    function openIconPicker() {
      if (!currentUser) {
        return;
      }

      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const closeBtn = document.querySelector('.close-btn');

      modalTitle.textContent = 'Choose Your Icon';
      modalBody.innerHTML = `
        <p style="margin-bottom:20px; text-align:center; font-size:1.1em;">Select an icon to represent you:</p>
        <div class="icon-picker">
          ${availableIcons.map(icon => `
            <div class="icon-option" onclick="selectIcon('${icon}')">
              ${icon}
            </div>
          `).join('')}
        </div>
      `;
      closeBtn.style.display = 'block';
      modal.classList.add('active');
    }

    // Select icon
    async function selectIcon(icon) {
      const response = await fetch('/api/user/icon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentUser, icon })
      });

      if (response.ok) {
        if (!userIcons[currentUser]) {
          userIcons[currentUser] = {};
        }
        userIcons[currentUser].icon = icon;
        updateUserInfo();
        closeModal();
        loadState(); // Refresh to show new icon
      }
    }

    // Load history
    async function loadHistory() {
      const response = await fetch('/api/history');
      history = await response.json();
      renderHistory();
    }

    // Render phase banner
    function renderPhase() {
      const banner = document.getElementById('phaseBanner');
      banner.className = `phase-banner ${state.phase}`;
      
      let message = '';
      if (state.phase === 'nomination') {
        const nominated = state.nominations.map(n => n.proposedBy);
        const waiting = ['Erik', 'Timea', 'J√°zmin', 'Niki'].filter(u => !nominated.includes(u));
        message = `<div>üé¨ NOMINATION PHASE</div>`;
        if (waiting.length > 0) {
          message += `<div style="font-size:0.9em; margin-top:10px;">Waiting for: ${waiting.join(', ')}</div>`;
        }
      } else if (state.phase === 'voting') {
        message = `<div>üó≥Ô∏è VOTING PHASE</div>`;
        message += `<div class="countdown" id="countdown"></div>`;
        startCountdown();
      } else {
        message = `<div>üèÜ RESULTS - Movie Night!</div>`;
        message += `<div style="font-size:0.9em; margin-top:10px;">Friday & Saturday picks are ready!</div>`;
      }
      
      banner.innerHTML = message;
    }

    // Countdown timer
    function startCountdown() {
      if (countdown) clearInterval(countdown);
      
      countdown = setInterval(() => {
        const now = new Date();
        const deadline = new Date(state.votingDeadline);
        const diff = deadline - now;
        
        if (diff <= 0) {
          clearInterval(countdown);
          document.getElementById('countdown').textContent = 'Voting closed!';
          loadState();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        
        let text = '';
        if (days > 0) text += `${days}d `;
        text += `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
        const elem = document.getElementById('countdown');
        if (elem) elem.textContent = text;
      }, 1000);
    }

    // Render nominations
    function renderNominations() {
      const section = document.getElementById('nominationsSection');
      
      if (state.nominations.length === 0) {
        if (state.phase === 'nomination') {
          section.innerHTML = '<div class="waiting-message">No nominations yet. Browse and nominate a movie!</div>';
        } else {
          section.innerHTML = '<div class="waiting-message">No nominations this week yet.</div>';
        }
        return;
      }
      
      // Calculate winners
      let firstPlace = null, secondPlace = null;
      if (state.phase === 'results') {
        const sorted = [...state.nominations].map(nom => {
          const voteCount = Object.values(state.votes[nom.id] || {}).filter(v => v).length;
          return { ...nom, voteCount };
        }).sort((a, b) => b.voteCount - a.voteCount);
        
        firstPlace = sorted[0]?.id;
        secondPlace = sorted[1]?.id;
      }
      
      let title = '';
      if (state.phase === 'nomination') title = 'Nominated Movies';
      else if (state.phase === 'voting') title = 'Vote for Your Top 2';
      else title = 'This Week\'s Winners';
      
      section.innerHTML = `
        <div class="section-title">${title}</div>
        <div class="nominations-grid">
          ${state.nominations.map(nom => {
            const voteCount = Object.values(state.votes[nom.id] || {}).filter(v => v).length;
            const userVoted = currentUser && state.votes[nom.id]?.[currentUser];
            const isProposer = currentUser && nom.proposedBy === currentUser;
            const backdropUrl = nom.backdropPath 
              ? `https://image.tmdb.org/t/p/w780${nom.backdropPath}`
              : `https://image.tmdb.org/t/p/w500${nom.posterPath || ''}`;
            
            let cardClass = 'nomination-card';
            let badge = '';
            if (state.phase === 'results') {
              if (nom.id === firstPlace) {
                cardClass += ' first-place';
                badge = '<div class="place-badge first">ü•á Friday</div>';
              } else if (nom.id === secondPlace) {
                cardClass += ' second-place';
                badge = '<div class="place-badge second">ü•à Saturday</div>';
              }
            }
            
            return `
              <div class="${cardClass}">
                ${badge}
                <img class="nomination-backdrop" src="${backdropUrl}" alt="${nom.title}" onerror="this.src='https://via.placeholder.com/300x200?text=${encodeURIComponent(nom.title)}'">
                <div class="nomination-info">
                  <div class="nomination-title">${nom.title}</div>
                  <div class="nomination-meta">
                    <span class="rating">‚≠ê ${nom.rating ? nom.rating.toFixed(1) : 'N/A'}</span>
                    <span>${nom.year}</span>
                    <span class="proposer">
                      <span class="proposer-icon">${userIcons[nom.proposedBy]?.icon || ''}</span>${nom.proposedBy}
                    </span>
                  </div>
                  ${state.phase === 'voting' && currentUser ? `
                    <div class="vote-section">
                      <button 
                        class="vote-btn ${userVoted ? 'voted' : ''}" 
                        onclick="toggleVote('${nom.id}')"
                        ${isProposer ? 'disabled' : ''}
                      >
                        ${userVoted ? '‚ù§Ô∏è Voted' : 'ü§ç Vote'}
                      </button>
                      <span class="vote-count">${voteCount}</span>
                    </div>
                  ` : state.phase === 'results' ? `
                    <div class="vote-section">
                      <span class="vote-count">${voteCount} votes</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Load browse categories
    async function loadBrowse() {
      const section = document.getElementById('browseSection');
      
      let title = 'Browse Movies';
      let message = '';
      
      if (state.phase === 'nomination') {
        const userNominated = state.nominations.find(n => n.proposedBy === currentUser);
        if (userNominated) {
          message = '<div class="waiting-message">You\'ve already nominated a movie. Waiting for others...</div>';
        } else {
          title = 'Browse & Nominate';
        }
      } else if (state.phase === 'voting') {
        message = '<div class="waiting-message">Voting is open! Check nominated movies above.</div>';
      } else if (state.phase === 'results') {
        message = '<div class="waiting-message">Nominations open Monday. Browse and plan ahead!</div>';
      }
      
      // Check if browse section already exists
      const existingSearch = document.getElementById('movieSearch');
      const searchValue = existingSearch ? existingSearch.value : '';
      
      section.innerHTML = `
        <div class="section-title">${title}</div>
        ${message}
        <div class="search-container">
          <div class="search-input-wrapper">
            <input type="text" class="search-input" id="movieSearch" placeholder="Search movies by title..." autocomplete="off" value="${searchValue}">
            <button class="search-btn" onclick="clearSearch()">Clear</button>
          </div>
          <div id="searchSuggestions" class="search-suggestions"></div>
        </div>
        <div id="searchResults"></div>
      `;

      // Reinitialize search immediately
      initSearchNow();
      
      const categories = [
        { id: 'trending', name: 'üî• Trending Now' },
        { id: 'popular', name: '‚≠ê Popular' },
        { id: 'topRated', name: 'üèÜ Top Rated' },
        { id: 'nowPlaying', name: 'üé¨ In Theaters' },
        { id: 'action', name: 'üí• Action' },
        { id: 'comedy', name: 'üòÇ Comedy' },
        { id: 'thriller', name: 'üò± Thriller' },
        { id: 'crime', name: 'üî´ Crime' },
        { id: 'drama', name: 'üé≠ Drama' },
        { id: 'romance', name: 'üíï Romance' },
        { id: 'horror', name: 'üëª Horror' },
        { id: 'scifi', name: 'üöÄ Sci-Fi' },
        { id: 'fantasy', name: 'üßô Fantasy' },
        { id: 'animation', name: 'üé® Animation' },
        { id: 'family', name: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family' },
        { id: 'mystery', name: 'üîç Mystery' }
      ];
      
      for (const cat of categories) {
        const response = await fetch(`/api/browse/${cat.id}`);
        const movies = await response.json();
        
        section.innerHTML += `
          <div class="browse-row">
            <div class="row-title">${cat.name}</div>
            <div class="movies-scroll">
              ${movies.slice(0, 20).map(movie => renderMovieCard(movie)).join('')}
            </div>
          </div>
        `;
      }
    }
    
    // Render movie card (reusable)
    function renderMovieCard(movie) {
      return `
        <div class="movie-card" onclick="showMovieDetail(${movie.id})">
          <img class="movie-backdrop" src="https://image.tmdb.org/t/p/w500${movie.backdrop_path || movie.poster_path || ''}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x170?text=${encodeURIComponent(movie.title)}'">
          <div class="movie-info">
            <div class="movie-title">${movie.title}</div>
            <div class="movie-meta">
              <span class="rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
              <span>${movie.release_date ? movie.release_date.split('-')[0] : ''}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    // Initialize search ONCE using event delegation
    function initSearchNow() {
      // Do nothing - event delegation handles it
    }

    // Legacy function for compatibility
    function initSearch() {
      // Do nothing - event delegation handles it
    }

    // Live search with autocomplete
    async function liveSearch(query) {
      console.log('liveSearch called with:', query);
      const suggestionsDiv = document.getElementById('searchSuggestions');
      
      if (!suggestionsDiv) {
        console.error('Suggestions div not found!');
        return;
      }
      
      if (!query) {
        hideSuggestions();
        return;
      }

      // Show loading
      suggestionsDiv.innerHTML = '<div class="suggestion-loading">Searching...</div>';
      suggestionsDiv.classList.add('active');
      console.log('Fetching search results for:', query);

      try {
        const response = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
        const movies = await response.json();
        console.log('Got', movies.length, 'results');

        if (movies.length === 0) {
          suggestionsDiv.innerHTML = '<div class="suggestion-loading">No results found</div>';
          return;
        }

        suggestionsDiv.innerHTML = movies.slice(0, 8).map(movie => {
          const backdropUrl = movie.backdrop_path 
            ? `https://image.tmdb.org/t/p/w300${movie.backdrop_path}`
            : (movie.poster_path 
              ? `https://image.tmdb.org/t/p/w300${movie.poster_path}`
              : 'https://via.placeholder.com/120x70?text=No+Image');
          
          const titleSafe = (movie.title || 'Unknown').replace(/'/g, '&apos;').replace(/"/g, '&quot;');

          return `
            <div class="suggestion-item" onclick="selectSuggestion(${movie.id})">
              <img class="suggestion-backdrop" src="${backdropUrl}" alt="${titleSafe}" onerror="this.src='https://via.placeholder.com/120x70?text=No+Image'">
              <div class="suggestion-info">
                <div class="suggestion-title">${titleSafe}</div>
                <div class="suggestion-meta">
                  <span class="rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
                  <span>${movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        console.log('Search suggestions rendered');
      } catch (error) {
        console.error('Search error:', error);
        suggestionsDiv.innerHTML = '<div class="suggestion-loading">Search failed. Try again.</div>';
      }
    }

    function hideSuggestions() {
      const suggestionsDiv = document.getElementById('searchSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.classList.remove('active');
      }
    }

    function selectSuggestion(tmdbId) {
      hideSuggestions();
      showMovieDetail(tmdbId);
    }

    function clearSearch() {
      const searchInput = document.getElementById('movieSearch');
      if (searchInput) {
        searchInput.value = '';
      }
      hideSuggestions();
      document.getElementById('searchResults').innerHTML = '';
    }

    // Show movie detail modal
    async function showMovieDetail(tmdbId) {
      document.querySelector('.close-btn').style.display = 'block';
      const response = await fetch(`/api/movie/${tmdbId}`);
      const movie = await response.json();
      
      const backdropUrl = movie.backdrop_path 
        ? `https://image.tmdb.org/t/p/w780${movie.backdrop_path}`
        : `https://image.tmdb.org/t/p/w500${movie.poster_path || ''}`;
      
      const userNominated = state.nominations.find(n => n.proposedBy === currentUser);
      const alreadyNominated = state.nominations.find(n => n.tmdbId === tmdbId);
      
      let actionHtml = '';
      if (!currentUser) {
        actionHtml = '<div class="waiting-message">Select your name to nominate</div>';
      } else if (state.phase !== 'nomination') {
        if (state.phase === 'voting') {
          actionHtml = '<div class="waiting-message">Nominations closed - voting is open!</div>';
        } else {
          actionHtml = '<div class="waiting-message">Nominations open Monday</div>';
        }
      } else if (userNominated) {
        actionHtml = '<div class="waiting-message">You\'ve already nominated a movie this week</div>';
      } else if (alreadyNominated) {
        actionHtml = '<div class="waiting-message">This movie has already been nominated</div>';
      } else {
        actionHtml = `<button class="nominate-btn" onclick="nominateMovie(${tmdbId})">Nominate This Movie</button>`;
      }
      
      document.getElementById('modalBody').innerHTML = `
        <div class="movie-detail">
          <img class="detail-backdrop" src="${backdropUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/600x340?text=${encodeURIComponent(movie.title)}'">
          <div class="detail-title">${movie.title}</div>
          <div class="detail-meta">
            <span class="rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
            <span>${movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</span>
            <span>${movie.runtime ? movie.runtime + ' min' : ''}</span>
          </div>
          <div class="detail-overview">${movie.overview || 'No overview available.'}</div>
          ${actionHtml}
        </div>
      `;
      
      document.getElementById('modal').classList.add('active');
    }

    // Nominate movie
    async function nominateMovie(tmdbId) {
      const response = await fetch('/api/nominate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tmdbId, user: currentUser })
      });
      
      const result = await response.json();
      
      if (result.error) {
        alert(result.error);
        return;
      }
      
      closeModal();
      loadState();
    }

    // Toggle vote
    async function toggleVote(movieId) {
      // Get current vote status
      const response = await fetch(`/api/votes/${currentUser}`);
      const voteStatus = await response.json();
      
      const currentlyVoted = voteStatus.votes[movieId];
      const newValue = !currentlyVoted;
      
      // Check if trying to add 3rd vote
      if (newValue && voteStatus.count >= 2) {
        alert('You can only vote for 2 movies!');
        return;
      }
      
      await fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ movieId, user: currentUser, value: newValue })
      });
      
      loadState();
    }

    // Close modal
    function closeModal() {
      // Don't allow closing if not logged in (PIN modal)
      if (!currentUser) return;
      document.getElementById('modal').classList.remove('active');
    }

    // Switch tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'current') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('currentTab').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('historyTab').classList.add('active');
        loadHistory();
      }
    }

    // Render history
    function renderHistory() {
      const container = document.getElementById('historyContent');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="waiting-message">No previous weeks yet</div>';
        return;
      }
      
      container.innerHTML = history.map(week => {
        const winners = [week.firstPlace, week.secondPlace].filter(Boolean);
        
        return `
          <div class="history-item">
            <div class="history-week">Week ${week.weekNumber}</div>
            <div class="history-winners">
              ${winners.map((movie, idx) => {
                const voteCount = Object.values(week.votes[movie.id] || {}).filter(v => v).length;
                const backdropUrl = movie.backdropPath 
                  ? `https://image.tmdb.org/t/p/w500${movie.backdropPath}`
                  : `https://image.tmdb.org/t/p/w500${movie.posterPath || ''}`;
                
                return `
                  <div class="nomination-card">
                    <div class="place-badge ${idx === 0 ? 'first' : 'second'}">
                      ${idx === 0 ? 'ü•á 1st Place' : 'ü•à 2nd Place'}
                    </div>
                    <img class="nomination-backdrop" src="${backdropUrl}" alt="${movie.title}">
                    <div class="nomination-info">
                      <div class="nomination-title">${movie.title}</div>
                      <div class="nomination-meta">
                        <span class="rating">‚≠ê ${movie.rating ? movie.rating.toFixed(1) : 'N/A'}</span>
                        <span>${movie.year}</span>
                        <span class="proposer">
                          <span class="proposer-icon">${userIcons[movie.proposedBy]?.icon || ''}</span>${movie.proposedBy}
                        </span>
                      </div>
                      <div class="vote-count">${voteCount} votes</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // Set up search event delegation (runs once, survives DOM changes)
    document.addEventListener('input', (e) => {
      if (e.target.id === 'movieSearch') {
        const query = e.target.value.trim();
        console.log('üîç Search input:', query);
        
        // Clear existing timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // Hide suggestions if empty
        if (!query) {
          hideSuggestions();
          return;
        }

        // Debounce search (300ms delay)
        searchTimeout = setTimeout(() => {
          console.log('‚è±Ô∏è Triggering search for:', query);
          liveSearch(query);
        }, 300);
      }
    });

    // Handle focus to show existing suggestions
    document.addEventListener('focus', (e) => {
      if (e.target.id === 'movieSearch') {
        const query = e.target.value.trim();
        if (query) {
          console.log('üéØ Refocused with query:', query);
          liveSearch(query);
        }
      }
    }, true); // Use capture phase

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        hideSuggestions();
      }
    });

    console.log('‚úÖ Search event delegation initialized');

    // Initial load
    checkSession();
    
    setInterval(() => {
      if (currentUser) loadState();
    }, 30000); // Refresh every 30s if logged in
  </script>
</body>
</html>
