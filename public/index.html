<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"="width=device-width, initial-scale=1.0">
  <title>Movie Night üçø</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #141414;
      color: #fff;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
      padding: 20px 40px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    h1 {
      font-size: 2em;
      color: #e50914;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .user-select {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    select, button {
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    select {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button {
      background: #e50914;
      color: white;
      font-weight: 600;
    }

    button:hover:not(:disabled) {
      background: #f40612;
      transform: scale(1.05);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Phase Indicator */
    .phase-banner {
      padding: 20px 40px;
      text-align: center;
      font-size: 1.1em;
      font-weight: 600;
    }

    .phase-banner.nomination {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .phase-banner.voting {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .phase-banner.results {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    }

    .countdown {
      margin-top: 10px;
      font-size: 1.5em;
      font-weight: 700;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px;
    }

    /* Nominations Section */
    .nominations-section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 1.8em;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .nominations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .nomination-card {
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s;
      cursor: pointer;
      position: relative;
    }

    .nomination-card:hover {
      transform: scale(1.05);
    }

    .nomination-card.first-place {
      border: 3px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .nomination-card.second-place {
      border: 3px solid silver;
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.5);
    }

    .nomination-backdrop {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .nomination-info {
      padding: 15px;
    }

    .nomination-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .nomination-meta {
      display: flex;
      gap: 15px;
      color: #999;
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .rating {
      color: #ffd700;
    }

    .proposer {
      color: #e50914;
      font-weight: 600;
    }

    .vote-section {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .vote-btn {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
    }

    .vote-btn.voted {
      background: #e50914;
      border-color: #e50914;
    }

    .vote-count {
      font-weight: 700;
      font-size: 1.2em;
    }

    .place-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9em;
    }

    .place-badge.first {
      background: gold;
      color: #000;
    }

    .place-badge.second {
      background: silver;
      color: #000;
    }

    /* Browse Section */
    .browse-section {
      margin-bottom: 40px;
    }

    .browse-row {
      margin-bottom: 30px;
    }

    .row-title {
      font-size: 1.4em;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .movies-scroll {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
      scrollbar-width: thin;
      scrollbar-color: #e50914 #1c1c1c;
    }

    .movies-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .movies-scroll::-webkit-scrollbar-track {
      background: #1c1c1c;
    }

    .movies-scroll::-webkit-scrollbar-thumb {
      background: #e50914;
      border-radius: 4px;
    }

    .movie-card {
      min-width: 300px;
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .movie-card:hover {
      transform: scale(1.05);
    }

    .movie-backdrop {
      width: 100%;
      height: 170px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .movie-info {
      padding: 12px;
    }

    .movie-title {
      font-size: 1em;
      font-weight: 700;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-meta {
      display: flex;
      gap: 10px;
      color: #999;
      font-size: 0.85em;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
    }

    .tab {
      padding: 15px 30px;
      background: none;
      border: none;
      color: #999;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: white;
      border-bottom-color: #e50914;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* History */
    .history-item {
      background: #1c1c1c;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .history-week {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 15px;
      color: #e50914;
    }

    .history-winners {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1c1c1c;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 2em;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
    }

    .movie-detail {
      margin-bottom: 20px;
    }

    .detail-backdrop {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .detail-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .detail-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      color: #999;
    }

    .detail-overview {
      line-height: 1.6;
      color: #ccc;
    }

    .nominate-btn {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      font-size: 1.1em;
    }

    .waiting-message {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: #999;
    }

    @media (max-width: 768px) {
      .header {
        padding: 15px 20px;
      }

      .container {
        padding: 15px 20px;
      }

      h1 {
        font-size: 1.5em;
      }

      .nominations-grid {
        grid-template-columns: 1fr;
      }

      .movie-card {
        min-width: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üçø Movie Night</h1>
      <div class="user-select">
        <select id="user">
          <option value="">Select your name</option>
          <option value="Erik">Erik</option>
          <option value="Timea">Timea</option>
          <option value="J√°zmin">J√°zmin</option>
          <option value="Niki">Niki</option>
        </select>
      </div>
    </div>
  </div>

  <div id="phaseBanner" class="phase-banner"></div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('current')">This Week</button>
      <button class="tab" onclick="switchTab('history')">Previous Weeks</button>
    </div>

    <div id="currentTab" class="tab-content active">
      <div id="nominationsSection" class="nominations-section"></div>
      <div id="browseSection" class="browse-section"></div>
    </div>

    <div id="historyTab" class="tab-content">
      <div id="historyContent"></div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Movie Details</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    let currentUser = '';
    let state = null;
    let history = [];
    let countdown = null;

    // Initialize
    document.getElementById('user').addEventListener('change', (e) => {
      currentUser = e.target.value;
      loadState();
    });

    // Load current state
    async function loadState() {
      const response = await fetch('/api/state');
      state = await response.json();
      renderPhase();
      renderNominations();
      if (state.phase === 'nomination' && currentUser) {
        loadBrowse();
      }
    }

    // Load history
    async function loadHistory() {
      const response = await fetch('/api/history');
      history = await response.json();
      renderHistory();
    }

    // Render phase banner
    function renderPhase() {
      const banner = document.getElementById('phaseBanner');
      banner.className = `phase-banner ${state.phase}`;
      
      let message = '';
      if (state.phase === 'nomination') {
        const nominated = state.nominations.map(n => n.proposedBy);
        const waiting = ['Erik', 'Timea', 'J√°zmin', 'Niki'].filter(u => !nominated.includes(u));
        message = `<div>üé¨ NOMINATION PHASE</div>`;
        if (waiting.length > 0) {
          message += `<div style="font-size:0.9em; margin-top:10px;">Waiting for: ${waiting.join(', ')}</div>`;
        }
      } else if (state.phase === 'voting') {
        message = `<div>üó≥Ô∏è VOTING PHASE</div>`;
        message += `<div class="countdown" id="countdown"></div>`;
        startCountdown();
      } else {
        message = `<div>üèÜ RESULTS - Movie Night!</div>`;
        message += `<div style="font-size:0.9em; margin-top:10px;">Friday & Saturday picks are ready!</div>`;
      }
      
      banner.innerHTML = message;
    }

    // Countdown timer
    function startCountdown() {
      if (countdown) clearInterval(countdown);
      
      countdown = setInterval(() => {
        const now = new Date();
        const deadline = new Date(state.votingDeadline);
        const diff = deadline - now;
        
        if (diff <= 0) {
          clearInterval(countdown);
          document.getElementById('countdown').textContent = 'Voting closed!';
          loadState();
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        
        let text = '';
        if (days > 0) text += `${days}d `;
        text += `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
        const elem = document.getElementById('countdown');
        if (elem) elem.textContent = text;
      }, 1000);
    }

    // Render nominations
    function renderNominations() {
      const section = document.getElementById('nominationsSection');
      
      if (state.nominations.length === 0 && state.phase === 'nomination') {
        section.innerHTML = '<div class="waiting-message">No nominations yet. Browse and nominate a movie!</div>';
        return;
      }
      
      if (state.nominations.length === 0) {
        section.innerHTML = '';
        return;
      }
      
      // Calculate winners
      let firstPlace = null, secondPlace = null;
      if (state.phase === 'results') {
        const sorted = [...state.nominations].map(nom => {
          const voteCount = Object.values(state.votes[nom.id] || {}).filter(v => v).length;
          return { ...nom, voteCount };
        }).sort((a, b) => b.voteCount - a.voteCount);
        
        firstPlace = sorted[0]?.id;
        secondPlace = sorted[1]?.id;
      }
      
      let title = '';
      if (state.phase === 'nomination') title = 'Nominated Movies';
      else if (state.phase === 'voting') title = 'Vote for Your Top 2';
      else title = 'This Week\'s Winners';
      
      section.innerHTML = `
        <div class="section-title">${title}</div>
        <div class="nominations-grid">
          ${state.nominations.map(nom => {
            const voteCount = Object.values(state.votes[nom.id] || {}).filter(v => v).length;
            const userVoted = currentUser && state.votes[nom.id]?.[currentUser];
            const isProposer = currentUser && nom.proposedBy === currentUser;
            const backdropUrl = nom.backdropPath 
              ? `https://image.tmdb.org/t/p/w780${nom.backdropPath}`
              : `https://image.tmdb.org/t/p/w500${nom.posterPath || ''}`;
            
            let cardClass = 'nomination-card';
            let badge = '';
            if (state.phase === 'results') {
              if (nom.id === firstPlace) {
                cardClass += ' first-place';
                badge = '<div class="place-badge first">ü•á Friday</div>';
              } else if (nom.id === secondPlace) {
                cardClass += ' second-place';
                badge = '<div class="place-badge second">ü•à Saturday</div>';
              }
            }
            
            return `
              <div class="${cardClass}">
                ${badge}
                <img class="nomination-backdrop" src="${backdropUrl}" alt="${nom.title}" onerror="this.src='https://via.placeholder.com/300x200?text=${encodeURIComponent(nom.title)}'">
                <div class="nomination-info">
                  <div class="nomination-title">${nom.title}</div>
                  <div class="nomination-meta">
                    <span class="rating">‚≠ê ${nom.rating ? nom.rating.toFixed(1) : 'N/A'}</span>
                    <span>${nom.year}</span>
                    <span class="proposer">${nom.proposedBy}</span>
                  </div>
                  ${state.phase === 'voting' && currentUser ? `
                    <div class="vote-section">
                      <button 
                        class="vote-btn ${userVoted ? 'voted' : ''}" 
                        onclick="toggleVote('${nom.id}')"
                        ${isProposer ? 'disabled' : ''}
                      >
                        ${userVoted ? '‚ù§Ô∏è Voted' : 'ü§ç Vote'}
                      </button>
                      <span class="vote-count">${voteCount}</span>
                    </div>
                  ` : state.phase === 'results' ? `
                    <div class="vote-section">
                      <span class="vote-count">${voteCount} votes</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Load browse categories
    async function loadBrowse() {
      const section = document.getElementById('browseSection');
      
      // Check if user already nominated
      const userNominated = state.nominations.find(n => n.proposedBy === currentUser);
      if (userNominated) {
        section.innerHTML = '<div class="waiting-message">You\'ve already nominated a movie. Waiting for others...</div>';
        return;
      }
      
      section.innerHTML = '<div class="section-title">Browse & Nominate</div>';
      
      const categories = [
        { id: 'trending', name: 'Trending Now' },
        { id: 'popular', name: 'Popular' },
        { id: 'topRated', name: 'Top Rated' },
        { id: 'nowPlaying', name: 'In Theaters' }
      ];
      
      for (const cat of categories) {
        const response = await fetch(`/api/browse/${cat.id}`);
        const movies = await response.json();
        
        section.innerHTML += `
          <div class="browse-row">
            <div class="row-title">${cat.name}</div>
            <div class="movies-scroll">
              ${movies.slice(0, 20).map(movie => `
                <div class="movie-card" onclick="showMovieDetail(${movie.id})">
                  <img class="movie-backdrop" src="https://image.tmdb.org/t/p/w500${movie.backdrop_path || movie.poster_path || ''}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x170?text=${encodeURIComponent(movie.title)}'">
                  <div class="movie-info">
                    <div class="movie-title">${movie.title}</div>
                    <div class="movie-meta">
                      <span class="rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
                      <span>${movie.release_date ? movie.release_date.split('-')[0] : ''}</span>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }

    // Show movie detail modal
    async function showMovieDetail(tmdbId) {
      const response = await fetch(`/api/movie/${tmdbId}`);
      const movie = await response.json();
      
      const backdropUrl = movie.backdrop_path 
        ? `https://image.tmdb.org/t/p/w780${movie.backdrop_path}`
        : `https://image.tmdb.org/t/p/w500${movie.poster_path || ''}`;
      
      const userNominated = state.nominations.find(n => n.proposedBy === currentUser);
      const alreadyNominated = state.nominations.find(n => n.tmdbId === tmdbId);
      
      document.getElementById('modalBody').innerHTML = `
        <div class="movie-detail">
          <img class="detail-backdrop" src="${backdropUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/600x340?text=${encodeURIComponent(movie.title)}'">
          <div class="detail-title">${movie.title}</div>
          <div class="detail-meta">
            <span class="rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
            <span>${movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</span>
            <span>${movie.runtime ? movie.runtime + ' min' : ''}</span>
          </div>
          <div class="detail-overview">${movie.overview || 'No overview available.'}</div>
          ${state.phase === 'nomination' && currentUser && !userNominated && !alreadyNominated ? `
            <button class="nominate-btn" onclick="nominateMovie(${tmdbId})">
              Nominate This Movie
            </button>
          ` : userNominated ? `
            <div class="waiting-message">You've already nominated a movie this week</div>
          ` : alreadyNominated ? `
            <div class="waiting-message">This movie has already been nominated</div>
          ` : ''}
        </div>
      `;
      
      document.getElementById('modal').classList.add('active');
    }

    // Nominate movie
    async function nominateMovie(tmdbId) {
      const response = await fetch('/api/nominate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tmdbId, user: currentUser })
      });
      
      const result = await response.json();
      
      if (result.error) {
        alert(result.error);
        return;
      }
      
      closeModal();
      loadState();
    }

    // Toggle vote
    async function toggleVote(movieId) {
      // Get current vote status
      const response = await fetch(`/api/votes/${currentUser}`);
      const voteStatus = await response.json();
      
      const currentlyVoted = voteStatus.votes[movieId];
      const newValue = !currentlyVoted;
      
      // Check if trying to add 3rd vote
      if (newValue && voteStatus.count >= 2) {
        alert('You can only vote for 2 movies!');
        return;
      }
      
      await fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ movieId, user: currentUser, value: newValue })
      });
      
      loadState();
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // Switch tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'current') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('currentTab').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('historyTab').classList.add('active');
        loadHistory();
      }
    }

    // Render history
    function renderHistory() {
      const container = document.getElementById('historyContent');
      
      if (history.length === 0) {
        container.innerHTML = '<div class="waiting-message">No previous weeks yet</div>';
        return;
      }
      
      container.innerHTML = history.map(week => {
        const winners = [week.firstPlace, week.secondPlace].filter(Boolean);
        
        return `
          <div class="history-item">
            <div class="history-week">Week ${week.weekNumber}</div>
            <div class="history-winners">
              ${winners.map((movie, idx) => {
                const voteCount = Object.values(week.votes[movie.id] || {}).filter(v => v).length;
                const backdropUrl = movie.backdropPath 
                  ? `https://image.tmdb.org/t/p/w500${movie.backdropPath}`
                  : `https://image.tmdb.org/t/p/w500${movie.posterPath || ''}`;
                
                return `
                  <div class="nomination-card">
                    <div class="place-badge ${idx === 0 ? 'first' : 'second'}">
                      ${idx === 0 ? 'ü•á 1st Place' : 'ü•à 2nd Place'}
                    </div>
                    <img class="nomination-backdrop" src="${backdropUrl}" alt="${movie.title}">
                    <div class="nomination-info">
                      <div class="nomination-title">${movie.title}</div>
                      <div class="nomination-meta">
                        <span class="rating">‚≠ê ${movie.rating ? movie.rating.toFixed(1) : 'N/A'}</span>
                        <span>${movie.year}</span>
                        <span class="proposer">${movie.proposedBy}</span>
                      </div>
                      <div class="vote-count">${voteCount} votes</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // Initial load
    loadState();
    setInterval(loadState, 30000); // Refresh every 30s
  </script>
</body>
</html>
